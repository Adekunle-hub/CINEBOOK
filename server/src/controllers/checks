// app/api/movies/route.js (or pages/api/movies.js)
import { validateMovie } from '@/lib/validators';
import Movie from '@/models/Movie';
import { connectDB } from '@/lib/db';

export async function POST(req) {
  try {
    await connectDB();
    const body = await req.json();
    
    // Validate with Joi FIRST (catches empty arrays)
    const { error, value } = validateMovie(body);
    
    if (error) {
      return Response.json(
        { 
          error: 'Validation failed', 
          details: error.details.map(d => d.message) 
        },
        { status: 400 }
      );
    }
    
    // Create movie with validated data
    const movie = await Movie.create(value);
    
    return Response.json(movie, { status: 201 });
    
  } catch (err) {
    // Handle Mongoose validation errors (backup)
    if (err.name === 'ValidationError') {
      return Response.json(
        { 
          error: 'Database validation failed',
          details: Object.values(err.errors).map(e => e.message)
        },
        { status: 400 }
      );
    }
    
    console.error('Error creating movie:', err);
    return Response.json(
      { error: 'Failed to create movie' },
      { status: 500 }
    );
  }
}

// GET all movies
export async function GET(req) {
  try {
    await connectDB();
    
    const { searchParams } = new URL(req.url);
    const genre = searchParams.get('genre');
    
    let query = {};
    if (genre) {
      query = { genre: genre };
    }
    
    const movies = await Movie.find(query)
      .sort({ releaseDate: -1 })
      .lean();
    
    return Response.json(movies, { status: 200 });
  } catch (error) {
    console.error('Error fetching movies:', error);
    return Response.json(
      { error: 'Failed to fetch movies' },
      { status: 500 }
    );
  }
}